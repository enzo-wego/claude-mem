#!/usr/bin/env node
#!/usr/bin/env node
import{existsSync as u,readFileSync as h,writeFileSync as f}from"fs";import{execSync as a,spawnSync as m}from"child_process";import{join as r}from"path";import{homedir as l}from"os";var E=process.env.CLAUDE_MEM_MARKETPLACE_VENDOR||"enzo-claude-mem",i=r(l(),".claude","plugins","marketplaces",E),w=r(i,".install-version"),t=process.platform==="win32",R=t?[r(l(),".bun","bin","bun.exe")]:[r(l(),".bun","bin","bun"),"/usr/local/bin/bun","/opt/homebrew/bin/bun"],I=t?[r(l(),".local","bin","uv.exe"),r(l(),".cargo","bin","uv.exe")]:[r(l(),".local","bin","uv"),r(l(),".cargo","bin","uv"),"/usr/local/bin/uv","/opt/homebrew/bin/uv"];function g(){try{if(m("bun",["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t}).status===0)return"bun"}catch{}return R.find(u)||null}function v(){return g()!==null}function y(){let e=g();if(!e)return null;try{let n=m(e,["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t});return n.status===0?n.stdout.trim():null}catch{return null}}function P(){try{if(m("uv",["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t}).status===0)return"uv"}catch{}return I.find(u)||null}function b(){return P()!==null}function O(){let e=P();if(!e)return null;try{let n=m(e,["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t});return n.status===0?n.stdout.trim():null}catch{return null}}function k(){console.error("\u{1F527} Bun not found. Installing Bun runtime...");try{if(t?(console.error("   Installing via PowerShell..."),a('powershell -c "irm bun.sh/install.ps1 | iex"',{stdio:"inherit",shell:!0})):(console.error("   Installing via curl..."),a("curl -fsSL https://bun.sh/install | bash",{stdio:"inherit",shell:!0})),!v())throw new Error("Bun installation completed but binary not found. Please restart your terminal and try again.");let e=y();console.error(`\u2705 Bun ${e} installed successfully`)}catch(e){throw console.error("\u274C Failed to install Bun"),console.error("   Please install manually:"),t?(console.error("   - winget install Oven-sh.Bun"),console.error('   - Or: powershell -c "irm bun.sh/install.ps1 | iex"')):(console.error("   - curl -fsSL https://bun.sh/install | bash"),console.error("   - Or: brew install oven-sh/bun/bun")),console.error("   Then restart your terminal and try again."),e}}function B(){console.error("\u{1F40D} Installing uv for Python/Chroma support...");try{if(t?(console.error("   Installing via PowerShell..."),a('powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"',{stdio:"inherit",shell:!0})):(console.error("   Installing via curl..."),a("curl -LsSf https://astral.sh/uv/install.sh | sh",{stdio:"inherit",shell:!0})),!b())throw new Error("uv installation completed but binary not found. Please restart your terminal and try again.");let e=O();console.error(`\u2705 uv ${e} installed successfully`)}catch(e){throw console.error("\u274C Failed to install uv"),console.error("   Please install manually:"),t?(console.error("   - winget install astral-sh.uv"),console.error('   - Or: powershell -c "irm https://astral.sh/uv/install.ps1 | iex"')):(console.error("   - curl -LsSf https://astral.sh/uv/install.sh | sh"),console.error("   - Or: brew install uv (macOS)")),console.error("   Then restart your terminal and try again."),e}}function $(){let e=r(i,"plugin","scripts","worker-service.cjs"),n=g()||"bun",c=`alias claude-mem='${n} "${e}"'`,p=r(i,".cli-installed");if(!u(p))try{if(t){let s=r(process.env.USERPROFILE||l(),"Documents","PowerShell","Microsoft.PowerShell_profile.ps1"),o=r(process.env.USERPROFILE||l(),"Documents","PowerShell"),d=`function claude-mem { & "${n}" "${e}" $args }
`;u(o)||a(`mkdir "${o}"`,{stdio:"ignore",shell:!0});let S=u(s)?h(s,"utf-8"):"";S.includes("function claude-mem")||(f(s,S+`
`+d),console.error("\u2705 PowerShell function added to profile"),console.error("   Restart your terminal to use: claude-mem <command>"))}else{let s=[r(l(),".bashrc"),r(l(),".zshrc")];for(let o of s)if(u(o)){let d=h(o,"utf-8");d.includes("alias claude-mem=")||(f(o,d+`
`+c+`
`),console.error(`\u2705 Alias added to ${o}`))}console.error("   Restart your terminal to use: claude-mem <command>")}f(p,new Date().toISOString())}catch(s){let o=s instanceof Error?s.message:String(s);console.error(`\u26A0\uFE0F  Could not add shell alias: ${o}`),console.error(`   Use directly: ${n} "${e}" <command>`)}}function x(){if(!u(r(i,"node_modules")))return!0;try{let e=JSON.parse(h(r(i,"package.json"),"utf-8")),n=JSON.parse(h(w,"utf-8"));return e.version!==n.version||y()!==n.bun}catch{return!0}}function _(){let e=g();if(!e)throw new Error("Bun executable not found");console.error("\u{1F4E6} Installing dependencies with Bun...");let n=t&&e.includes(" ")?`"${e}"`:e,c=!1;try{a(`${n} install`,{cwd:i,stdio:"inherit",shell:t}),c=!0}catch{try{a(`${n} install --force`,{cwd:i,stdio:"inherit",shell:t}),c=!0}catch{}}if(!c){console.error("\u26A0\uFE0F  Bun install failed, falling back to npm..."),console.error("   (This can happen with npm alias packages like *-cjs)");try{a("npm install",{cwd:i,stdio:"inherit",shell:t})}catch(s){let o=s instanceof Error?s.message:String(s);throw new Error("Both bun and npm install failed: "+o)}}let p=JSON.parse(h(r(i,"package.json"),"utf-8"));f(w,JSON.stringify({version:p.version,bun:y(),uv:O(),installedAt:new Date().toISOString()}))}try{if(v()||(k(),v()||(console.error("\u274C Bun is required but not available in PATH"),console.error("   Please restart your terminal after installation"),process.exit(1))),b()||(B(),b()||(console.error("\u274C uv is required but not available in PATH"),console.error("   Please restart your terminal after installation"),process.exit(1))),x()){let n=JSON.parse(h(r(i,"package.json"),"utf-8")).version;_(),console.error("\u2705 Dependencies installed");let c=process.env.CLAUDE_MEM_WORKER_PORT||"37777";console.error(`[claude-mem] Plugin updated to v${n} - restarting worker...`);try{a(`curl -s -X POST http://127.0.0.1:${c}/api/admin/shutdown`,{stdio:"ignore",shell:t,timeout:5e3}),a(t?"timeout /t 1 /nobreak >nul":"sleep 0.5",{stdio:"ignore",shell:!0})}catch{}}$()}catch(e){let n=e instanceof Error?e.message:String(e);console.error("\u274C Installation failed:",n),process.exit(1)}
