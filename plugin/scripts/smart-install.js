#!/usr/bin/env node
import{existsSync as u,readFileSync as p,writeFileSync as d}from"fs";import{execSync as i,spawnSync as m}from"child_process";import{join as e}from"path";import{homedir as o}from"os";var E=process.env.CLAUDE_MEM_MARKETPLACE_VENDOR||"enzo-claude-mem",l=e(o(),".claude","plugins","marketplaces",E),w=e(l,".install-version"),t=process.platform==="win32",R=t?[e(o(),".bun","bin","bun.exe")]:[e(o(),".bun","bin","bun"),"/usr/local/bin/bun","/opt/homebrew/bin/bun"],I=t?[e(o(),".local","bin","uv.exe"),e(o(),".cargo","bin","uv.exe")]:[e(o(),".local","bin","uv"),e(o(),".cargo","bin","uv"),"/usr/local/bin/uv","/opt/homebrew/bin/uv"];function g(){try{if(m("bun",["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t}).status===0)return"bun"}catch{}return R.find(u)||null}function b(){return g()!==null}function y(){let n=g();if(!n)return null;try{let r=m(n,["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t});return r.status===0?r.stdout.trim():null}catch{return null}}function P(){try{if(m("uv",["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t}).status===0)return"uv"}catch{}return I.find(u)||null}function v(){return P()!==null}function O(){let n=P();if(!n)return null;try{let r=m(n,["--version"],{encoding:"utf-8",stdio:["pipe","pipe","pipe"],shell:t});return r.status===0?r.stdout.trim():null}catch{return null}}function x(){console.error("\u{1F527} Bun not found. Installing Bun runtime...");try{if(t?(console.error("   Installing via PowerShell..."),i('powershell -c "irm bun.sh/install.ps1 | iex"',{stdio:"inherit",shell:!0})):(console.error("   Installing via curl..."),i("curl -fsSL https://bun.sh/install | bash",{stdio:"inherit",shell:!0})),!b())throw new Error("Bun installation completed but binary not found. Please restart your terminal and try again.");let n=y();console.error(`\u2705 Bun ${n} installed successfully`)}catch(n){throw console.error("\u274C Failed to install Bun"),console.error("   Please install manually:"),t?(console.error("   - winget install Oven-sh.Bun"),console.error('   - Or: powershell -c "irm bun.sh/install.ps1 | iex"')):(console.error("   - curl -fsSL https://bun.sh/install | bash"),console.error("   - Or: brew install oven-sh/bun/bun")),console.error("   Then restart your terminal and try again."),n}}function B(){console.error("\u{1F40D} Installing uv for Python/Chroma support...");try{if(t?(console.error("   Installing via PowerShell..."),i('powershell -ExecutionPolicy ByPass -c "irm https://astral.sh/uv/install.ps1 | iex"',{stdio:"inherit",shell:!0})):(console.error("   Installing via curl..."),i("curl -LsSf https://astral.sh/uv/install.sh | sh",{stdio:"inherit",shell:!0})),!v())throw new Error("uv installation completed but binary not found. Please restart your terminal and try again.");let n=O();console.error(`\u2705 uv ${n} installed successfully`)}catch(n){throw console.error("\u274C Failed to install uv"),console.error("   Please install manually:"),t?(console.error("   - winget install astral-sh.uv"),console.error('   - Or: powershell -c "irm https://astral.sh/uv/install.ps1 | iex"')):(console.error("   - curl -LsSf https://astral.sh/uv/install.sh | sh"),console.error("   - Or: brew install uv (macOS)")),console.error("   Then restart your terminal and try again."),n}}function $(){let n=e(l,"plugin","scripts","worker-service.cjs"),r=g()||"bun",c=`alias claude-mem='${r} "${n}"'`,h=e(l,".cli-installed");if(!u(h))try{if(t){let s=e(process.env.USERPROFILE||o(),"Documents","PowerShell","Microsoft.PowerShell_profile.ps1"),a=e(process.env.USERPROFILE||o(),"Documents","PowerShell"),f=`function claude-mem { & "${r}" "${n}" $args }
`;u(a)||i(`mkdir "${a}"`,{stdio:"ignore",shell:!0});let S=u(s)?p(s,"utf-8"):"";S.includes("function claude-mem")||d(s,S+`
`+f)}else{let s=[e(o(),".bashrc"),e(o(),".zshrc")];for(let a of s)if(u(a)){let f=p(a,"utf-8");f.includes("alias claude-mem=")||d(a,f+`
`+c+`
`)}}d(h,new Date().toISOString())}catch(s){let a=s instanceof Error?s.message:String(s);console.error(`\u26A0\uFE0F  Could not add shell alias: ${a}`),console.error(`   Use directly: ${r} "${n}" <command>`)}}function _(){if(!u(e(l,"node_modules")))return!0;try{let n=JSON.parse(p(e(l,"package.json"),"utf-8")),r=JSON.parse(p(w,"utf-8"));return n.version!==r.version||y()!==r.bun}catch{return!0}}function k(){let n=g();if(!n)throw new Error("Bun executable not found");let r=t&&n.includes(" ")?`"${n}"`:n,c=!1;try{i(`${r} install`,{cwd:l,stdio:"pipe",shell:t}),c=!0}catch{try{i(`${r} install --force`,{cwd:l,stdio:"pipe",shell:t}),c=!0}catch{}}if(!c){console.error("\u26A0\uFE0F  Bun install failed, falling back to npm...");try{i("npm install",{cwd:l,stdio:"pipe",shell:t})}catch(s){let a=s instanceof Error?s.message:String(s);throw new Error("Both bun and npm install failed: "+a)}}let h=JSON.parse(p(e(l,"package.json"),"utf-8"));d(w,JSON.stringify({version:h.version,bun:y(),uv:O(),installedAt:new Date().toISOString()}))}try{if(b()||(x(),b()||(console.error("\u274C Bun is required but not available in PATH"),console.error("   Please restart your terminal after installation"),process.exit(1))),v()||(B(),v()||(console.error("\u274C uv is required but not available in PATH"),console.error("   Please restart your terminal after installation"),process.exit(1))),_()){let r=JSON.parse(p(e(l,"package.json"),"utf-8")).version;k();let c=process.env.CLAUDE_MEM_WORKER_PORT||"37777";try{i(`curl -s -X POST http://127.0.0.1:${c}/api/admin/shutdown`,{stdio:"ignore",shell:t,timeout:5e3}),i(t?"timeout /t 1 /nobreak >nul":"sleep 0.5",{stdio:"ignore",shell:!0})}catch{}}if(!t){let n=e(l,"plugin","scripts","bun-runner.sh");if(u(n))try{i(`chmod +x "${n}"`,{stdio:"ignore"})}catch{}}$()}catch(n){let r=n instanceof Error?n.message:String(n);console.error("\u274C Installation failed:",r),process.exit(1)}
